set -e

TMP_CONTENT_DIR=/tmp/pyfes
mkdir -p $TMP_CONTENT_DIR
cp -r examples binder $TMP_CONTENT_DIR
mkdir -p $TMP_CONTENT_DIR/tests/python
wget -q https://osf.io/download/yfr24 -O /tmp/dataset.zip
unzip -q /tmp/dataset.zip -d $TMP_CONTENT_DIR/tests/python/
rm /tmp/dataset.zip
find . -delete

GENERATED_NOTEBOOKS_DIR=.generated-notebooks
cp -r $TMP_CONTENT_DIR/examples $GENERATED_NOTEBOOKS_DIR

find $GENERATED_NOTEBOOKS_DIR -name '*.py' -exec sphinx_gallery_py2jupyter '{}' +
NON_NOTEBOOKS=$(find $GENERATED_NOTEBOOKS_DIR -type f | grep -v -E '\.(ipynb|yml)')
rm -f $NON_NOTEBOOKS

mkdir -p notebooks/auto_examples
mv $TMP_CONTENT_DIR/tests notebooks
cp -v $GENERATED_NOTEBOOKS_DIR/*.ipynb notebooks/auto_examples/
cp -v $GENERATED_NOTEBOOKS_DIR/*.yml notebooks/auto_examples/
rm -rf $GENERATED_NOTEBOOKS_DIR

mv $TMP_CONTENT_DIR/binder .
rm -rf $TMP_CONTENT_DIR
